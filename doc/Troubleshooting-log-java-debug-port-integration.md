# Troubleshooting Guide: Integrating `--debug-java`Support for Salt Event Processor

## Problem Statement

Implementing `--debug-java` flag support for a new Salt Event Processor service in uyuni-tools, following established debugging patterns for other Java services (Tomcat, Taskomatic, Search).

## Initial Implementation Approach

- **Goal**: Enable debug port 8004 for event processor when `-debug-java` flag is used
- **Expected behavior**: when using  `-debug-java` flag, deployments expose Java Debug Wire Protocol (JDWP) on port 8004

## Main Problems Encountered

### Problem 1: Environment Variable Parsing Failure

**Port status check:**

1. `systemctl status uyuni-event-processor@0.service` showed container Event processor service ****is up and healthy
2. Port 8004 is listening (external client can reach port 8004 of uyuni server), which means the port mapping is working

    ```bash
    server:~/Documents/uyuni> sudo ss -tlnp | grep 8004
    LISTEN 0      4096                    0.0.0.0:8004       0.0.0.0:*    users:(("conmon",pid=11075,fd=14))          
    LISTEN 0      4096                       [::]:8004          [::]:*    users:(("conmon",pid=11075,fd=29))   
    ```

3. Systemd configuration file has no `JAVA_OPTS` environment varialbe

    ```bash
    cat /etc/systemd/system/uyuni-event-processor@.service.d/generated.conf
    is 
    server: cat generated.conf # This file is generated by mgradm and will be overwritten during upgrades. # Custom configuration should go in another .conf file in the same folder. [Service] Environment=UYUNI_EVENT_PROCESSOR_IMAGE=registry.opensuse.org/home/cbosdonnat/branches/systemsmanagement/uyuni/master-sywen/containerfile/uyuni/server-salt-event-processor:latest Environment=UYUNI_DB_NAME=susemanager Environment=UYUNI_DB_PORT=5432 Environment=UYUNI_DB_HOST=db Environment=JAVA_OPTS=-Xdebug -Xrunjdwp:transport=dt_socket,address=*:8004,server=y,suspend=n
    server:~ # podman exec $CONTAINER_ID env
    db_port=5432
    db_host=db
    db_backend=postgresql
    PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
    container=podman
    db_name=susemanager
    HOSTNAME=uyuni-server-event-processor-0.mgr.internal
    db_password=password
    db_user=spacewalk
    HOME=/root
    ```

4. Container has no 8004 port exposed

    ```bash
    sudo podman inspect uyuni-salt-event-processor-0 | grep 8004
    # return empty
    ```


**This tells us there's a partial success:**

1. Uyuni server has 8004 port set up and expose, so external client can reach port 8004
2. `JAVA_OPTS` variable was not written into the systemd configuration file `generated.conf` file called by `podman.GenerateSystemdConfFile()`
3. Therefore, container `uyuni-event-processor` can’t read the environment variable from configuration file to start java debug port

**Investigation Process**:

check  `journalctl -u uyuni-event-processor@0.service | grep 8004` , found error:

```bash
systemd[1]: Invalid environment assignment, ignoring: -Xrunjdwp:transport=dt_socket,address=*:8004,server=y,suspend=n
```

**Root Cause analysis**:  Systemd requires quotes around values with special characters (`:`, `*`, `,`, `=`)

in golang,

```java
	// Add conditional debug server inside container
	var javaOpts string
	if debugJava {
		javaOpts = "-Xdebug -Xrunjdwp:transport=dt_socket,address=*:8004,server=y,suspend=n"
	} else {
		javaOpts = ""
	}

	environment := fmt.Sprintf(`Environment=UYUNI_EVENT_PROCESSOR_IMAGE=%s
Environment=UYUNI_DB_NAME=%s
Environment=UYUNI_DB_PORT=%d
Environment=UYUNI_DB_HOST=%s
Environment=JAVA_OPTS=%s`,
		preparedImage, db.Name, db.Port, db.Host, javaOpts)
```

`Environment=JAVA_OPTS=%s` will remove the quote around javaOpts assuming it is a string, so systemd rejected `JAVA_OPTS` environment variable due to unquoted special characters

**Solution**: Quote the `JAVA_OPTS` value in Go code:

```go
Environment=JAVA_OPTS="%s"`
```

## Problem 2: Port Loop Not Generating Port Mappings

**Situation**:

- Service starts correctly, and external client can see port exposed by uyuni server

    ```bash
    server:~ # lsof -i :8004
    COMMAND   PID USER FD   TYPE    DEVICE SIZE/OFF NODE NAME
    conmon  17208 root 14u  IPv4 111111119      0t0  TCP *:8004 (LISTEN)
    conmon  17208 root 29u  IPv6 111111119      0t0  TCP *:8004 (LISTEN)
    ```

- Template had port loop:

    ```bash
    ExecStart=/bin/sh -c '/usr/bin/podman run \
        # ... other options ...
        {{- range .Ports }}
        -p {{ .Exposed }}:{{ .Port }}{{if .Protocol}}/{{ .Protocol }}{{end}} \
        {{- end }}
        # ... rest of template
    ```

- Generated systemd service had no `-p` port flags, means Port mapping in the port loop is not working
- `podman port uyuni-salt-event-processor-0` returned empty results, there is no any port in the container

**Investigation Process**:

- Examined generated systemd service configuration file found there is no
- Manually added `-p 8004:8004` to template and reinstalled the container, `podman port uyuni-salt-event-processor-0` has port 8004 exposed and `-p 8004:8004` exist in systemd service file `generated.conf`

    ```bash
    
    ExecStart=/bin/sh -c '/usr/bin/podman run \
        ...
        -d \
            -p 8004:8004 \
        ...
    ```

- Verified template loop syntax was correct
- Checked if `Ports` field was being set in template data — No!!

**Root Cause Analysis:**

When removed the hardcoded `-p 8004:8004`:

- `podman port uyuni-salt-event-processor-0` returns nothing
- This proves the port loop is not working

The `{{- range .Ports }}` loop is not generating any `-p` flags because:

- `Ports` field not set in template data

    ```go
    	eventProcessorData := templates.EventProcessorServiceTemplateData{
    		NamePrefix:   "uyuni",
    		Network:      podman.UyuniNetwork,
    		DBUserSecret: podman.DBUserSecret,
    		DBPassSecret: podman.DBPassSecret,
    		DBBackend:    "postgres",
    	}
    ```


**Solution**:

parse port in `templates.EventProcessorServiceTemplateData` so port can be added in systemd service file

```go
	// Control debug port expose from container to client
	var ports []types.PortMap
	if debugJava {
		ports = utils.EventProcessorPorts
	}

	eventProcessorData := templates.EventProcessorServiceTemplateData{
		NamePrefix:   "uyuni",
		Network:      podman.UyuniNetwork,
		DBUserSecret: podman.DBUserSecret,
		DBPassSecret: podman.DBPassSecret,
		DBBackend:    "postgres",
		Ports:        ports,
	}
```

result is port is mapped through port looping into `-p 8004:8004` in systemd service file

```bash

server:~ # cat /etc/systemd/system/uyuni-event-processor@.service

[Unit]
Description=Uyuni Event Processor Container
Wants=network.target
After=network-online.target

[Service]
Environment=PODMAN_SYSTEMD_UNIT=%n
Restart=on-failure
ExecStartPre=/bin/rm -f %t/uyuni-salt-event-processor-%i.pid %t/%n.ctr-id
ExecStartPre=/usr/bin/podman rm --ignore --force -t 10 uyuni-salt-event-processor-%i
ExecStart=/bin/sh -c '/usr/bin/podman run \
    --conmon-pidfile %t/uyuni-salt-event-processor-%i.pid \
    --cidfile=%t/%n-%i.ctr-id \
    --cgroups=no-conmon \
    --sdnotify=conmon \
    -d \
        -p 8004:8004 \
    -e db_name=${UYUNI_DB_NAME} \
        -e db_port=${UYUNI_DB_PORT} \
    -e db_host=${UYUNI_DB_HOST} \
        -e db_backend=postgresql \
    -e JAVA_OPTS="${JAVA_OPTS}" \
    --secret=uyuni-db-user,type=env,target=db_user \
    --secret=uyuni-db-pass,type=env,target=db_password \
    --replace \
    --name uyuni-salt-event-processor-%i \
    --hostname uyuni-server-event-processor-%i.mgr.internal \
    --network uyuni \
    ${UYUNI_EVENT_PROCESSOR_IMAGE}'
ExecStop=/usr/bin/podman stop --ignore -t 10 --cidfile=%t/%n-%i.ctr-id
ExecStopPost=/usr/bin/podman rm -f --ignore -t 10 --cidfile=%t/%n-%i.ctr-id
PIDFile=%t/uyuni-salt-event-processor-%i.pid
TimeoutStopSec=60
TimeoutStartSec=60
Type=forking

[Install]
WantedBy=multi-user.target default.target

```

## Problem 3: Port Conflict During Container Startup

**Problem:** event processor server failed to start

**Investigation:**

`journalctl -u uyuni-event-processor@0.service`

```bash
Error: cannot listen on the TCP port: listen tcp4 :8004: bind: address already in use
```

**Root Cause**:

Template data structure `Ports` field receive wrong ports.

When using `utils.GetServerPorts(debugJava)` 

```java
var ports []types.PortMap
if debugJava {
    ports = utils.GetServerPorts(debugJava)
}

eventProcessorData := templates.EventProcessorServiceTemplateData{
    // ... other fields ...
    Ports: ports,
}
```

it includes **all server ports** (web, salt, cobbler, tomcat, taskomatic, search, etc.) into event processor template, not just the event processor debug port. Therefore this is causing **port conflicts** because the event processor container is trying to bind to ports that are already in use by the main Uyuni server container.

**Solution**:

Ensure proper port data flow:change from parse in all ports using `GetServerPorts()`into parse only `EventProcessorPorts` into container

```go
var ports []types.PortMap
if debugJava {
    ports = utils.EventProcessorPorts
}

eventProcessorData := templates.EventProcessorServiceTemplateData{
    // ... other fields ...
    Ports: ports,
}
```

# Debugging Process Takeaways

**General flow:**

1. Follow the data flow: Template data → Generated files → Runtime behavior
2. Layer-by-layer verification: Configuration → Process → Network → Connectivity

**For future integration debugging, follow this logical order:**

1. Configuration Layer: Verify systemd files & configuration files & environment variables generated correctly

- Check systemd service files are generated correctly
- Verify environment variables are set properly
- Confirm template rendering worked

2. Process Layer: Confirm Java processes have correct arguments

- Verify containers are running
- Check Java processes have correct arguments
- Confirm no startup errors in logs

3. Network Layer: Check port binding and exposure

- Check ports are listening on correct interfaces
- Verify no port conflicts
- Confirm container port mappings exist

4. Connectivity Layer: Test end-to-end access

- Test external access to debug port
- Verify inter-container communication
- Connect with actual debugger