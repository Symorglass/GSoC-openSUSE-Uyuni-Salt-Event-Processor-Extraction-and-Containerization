# Testing `--debug-java` Integration for Salt Event Processor

**Goal**: Verify that the `--debug-java` flag correctly enables Java debugging capabilities for the Salt Event Processor service, allowing external debuggers to connect to port 8004.

**Context**: Testing the complete debug integration after implementing java debug port configuration for the containerized Salt Event Processor.

**Test Setup**: Install Uyuni server with debug flag enabled:

```bash
sudo ./bin/mgradm -c mgradm.yaml install podman server.uyuni.lab       --eventprocessor-image registry.opensuse.org/home/cbosdonnat/branches/systemsmanagement/uyuni/master-sywen/containerfile/uyuni/server-salt-event-processor:latest       --logLevel debug --debug-java
```

### **1. Configuration Verification**

- Check if template generated correct systemd service

    ```bash
    server:~ # cat /etc/systemd/system/uyuni-event-processor@.service
    
    [Unit]
    Description=Uyuni Event Processor Container
    Wants=network.target
    After=network-online.target
    
    [Service]
    Environment=PODMAN_SYSTEMD_UNIT=%n
    Restart=on-failure
    ExecStartPre=/bin/rm -f %t/uyuni-salt-event-processor-%i.pid %t/%n.ctr-id
    ExecStartPre=/usr/bin/podman rm --ignore --force -t 10 uyuni-salt-event-processor-%i
    ExecStart=/bin/sh -c '/usr/bin/podman run \
        --conmon-pidfile %t/uyuni-salt-event-processor-%i.pid \
        --cidfile=%t/%n-%i.ctr-id \
        --cgroups=no-conmon \
        --sdnotify=conmon \
        -d \
            -p 8004:8004 \
        -e db_name=${UYUNI_DB_NAME} \
            -e db_port=${UYUNI_DB_PORT} \
        -e db_host=${UYUNI_DB_HOST} \
            -e db_backend=postgresql \
        -e JAVA_OPTS="${JAVA_OPTS}" \
        --secret=uyuni-db-user,type=env,target=db_user \
        --secret=uyuni-db-pass,type=env,target=db_password \
        --replace \
        --name uyuni-salt-event-processor-%i \
        --hostname uyuni-server-event-processor-%i.mgr.internal \
        --network uyuni \
        ${UYUNI_EVENT_PROCESSOR_IMAGE}'
    ExecStop=/usr/bin/podman stop --ignore -t 10 --cidfile=%t/%n-%i.ctr-id
    ExecStopPost=/usr/bin/podman rm -f --ignore -t 10 --cidfile=%t/%n-%i.ctr-id
    PIDFile=%t/uyuni-salt-event-processor-%i.pid
    TimeoutStopSec=60
    TimeoutStartSec=60
    Type=forking
    
    [Install]
    WantedBy=multi-user.target default.target
    ```

    - Shows: -p 8004:8004 (finds port when template renders)
    - Shows: -e JAVA_OPTS="${JAVA_OPTS}" (environment passing)
  
- Checks environment variables set correctly

    ```bash
    server:/ # cat etc/systemd/system/uyuni-event-processor@.service.d/generated.conf
    # This file is generated by mgradm and will be overwritten during upgrades.
    # Custom configuration should go in another .conf file in the same folder.
    
    [Service]
    Environment=UYUNI_EVENT_PROCESSOR_IMAGE=registry.opensuse.org/home/cbosdonnat/branches/systemsmanagement/uyuni/master-sywen/containerfile/uyuni/server-salt-event-processor:latest
    Environment=UYUNI_DB_NAME=susemanager
    Environment=UYUNI_DB_PORT=5432
    Environment=UYUNI_DB_HOST=db
    Environment=JAVA_OPTS="-Xdebug -Xrunjdwp:transport=dt_socket,address=*:8004,server=y,suspend=n"
    ```

    - Shows `JAVA_OPTS="-Xdebug -Xrunjdwp:..."` (debug setting in configuration file)

### **2. Network Layer Verification**

- Verify host-level port exposure

    ```bash
    server:/ # ss -tlnp | grep 8004
    LISTEN 0      4096                   0.0.0.0:8004       0.0.0.0:*    users:(("conmon",pid=27289,fd=5))    
    ```

    - Shows: Port 8004 listening on host (external access available)
- Verifiy process binding

    ```bash
    server:/ # lsof -i :8004
    COMMAND   PID USER FD   TYPE    DEVICE SIZE/OFF NODE NAME
    conmon  27289 root 5u  IPv4 193202815      0t0  TCP *:8004 (LISTEN)
    ```

    - Shows: conmon (container manager) owns the port

### **3. Container Layer Verification**

- Checks: Java process inside container

    ```bash
    server:/ # podman exec uyuni-salt-event-processor-0 ps aux | grep java
    root         7  0.9  2.4 6521492 398188 ?      Sl   19:39   0:18 /usr/bin/java -Djava.library.path=/usr/lib:/usr/lib64 -classpath /usr/share/rhn/classes:/usr/share/rhn/lib/spacewalk-asm.jar:/usr/share/rhn/lib/rhn.jar:/usr/share/rhn/lib/java-branding.jar:/usr/share/spacewalk/taskomatic/* -Dibm.dst.compatibility=true -Dfile.encoding=UTF-8 -Xms128m -Xmx512m -Dlog4j2.configurationFile=file:///usr/share/rhn/classes/log4j2_saltEventProcessor.xml -Xdebug -Xrunjdwp:transport=dt_socket,address=*:8004,server=y,suspend=n com.suse.saltevent.SaltEventProcessor
    ```

    - Shows: Java running with `-Xdebug -Xrunjdwp:transport=dt_socket,address=*:8004`
- Verify debug port in container

    ```bash
    server:~ # podman inspect uyuni-salt-event-processor-0 | grep "8004"
    "JAVA_OPTS=-Xdebug -Xrunjdwp:transport=dt_socket,address=*:8004,server=y,suspend=n",
    "JAVA_OPTS=-Xdebug -Xrunjdwp:transport=dt_socket,address=*:8004,server=y,suspend=n",
    ```


### **4. Network Connectivity Testing**

- Test external connectivity to debug port

    ```bash
    server:/ # telnet server.uyuni.lab 8004
    Trying 192.168.2.133...
    Connected to 192.168.2.133.
    Escape character is '^]'.
    Connection closed by foreign host.
    ```

    ```bash
    # Test external connectivity to debug port
    server:/ # telnet localhost 8004
    Trying 127.0.0.1...
    Connected to localhost.
    Escape character is '^]'.
    Connection closed by foreign host.
    ```

    - JDWP debug server accepted connection (expected behavior)
- Verify containers can communicate on debug port

    ```bash
    # Verify containers can communicate on debug port
    server:/ # podman exec uyuni-server telnet uyuni-salt-event-processor-0 8004
    Trying <container-ipv6>...
    Connected to uyuni-salt-event-processor-0.
    Escape character is '^]'.
    Connection closed by foreign host.
    ```

    - Result: Connected + closed (containers can communicate)

## Key Insights & Architecture Understanding

### Two-Layer Debug Configuration

1. **Network Layer**: Port mapping (`p 8004:8004`) - controls external access
2. **Process Layer**: JAVA_OPTS environment - controls internal Java debug server

Both layers required for functional debugging:

- Port mapping without JAVA_OPTS: External access but nothing listening inside
- JAVA_OPTS without port mapping: Internal debug server but no external access